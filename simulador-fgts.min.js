(function(global) {
  /* Função para tratar o cálculo do FGTS */
  function calcularFGTSHandler() {
    var fgts = document.getElementById('fgts-valor').value;
    fgts = fgts.replace(/\./g, "").replace(',', '.');
    var saldo = Number(fgts) || 0;
    var valores = calcularFGTS(saldo);
    atualizarValoresFGTS(valores);
  }
  
  /* Funções auxiliares e cálculo para FGTS */
  function fatox(taxa) {
    var fator;
    if (taxa == 1.89) fator = 1.000624;
    else if (taxa == 1.92) fator = 1.000634;
    else fator = 1.000657;
    return fator;
  }
  
  function taxadejurosmes(parcelas) {
    var valor;
    if (parcelas <= 6) valor = 1.99;
    else if (parcelas <= 9) valor = 1.92;
    else if (parcelas <= 10) valor = 1.89;
    return valor;
  }
  
  function faixa(valor) {
    var porcentagem, parcelaextra;
    if (valor <= 500) {
      porcentagem = 50;
      parcelaextra = 0;
    } else if (valor > 500 && valor <= 1000) {
      porcentagem = 40;
      parcelaextra = 50;
    } else if (valor > 1000 && valor <= 5000) {
      porcentagem = 30;
      parcelaextra = 150;
    } else if (valor > 5000 && valor <= 10000) {
      porcentagem = 20;
      parcelaextra = 650;
    } else if (valor > 10000 && valor <= 15000) {
      porcentagem = 15;
      parcelaextra = 1150;
    } else if (valor > 15000 && valor <= 20000) {
      porcentagem = 10;
      parcelaextra = 1900;
    } else {
      porcentagem = 5;
      parcelaextra = 2900;
    }
    return valor * (porcentagem / 100) + parcelaextra;
  }
  
  function desagio(parcela) {
    var valor;
    switch (parcela) {
      case 1: valor = 66; break;
      case 2: valor = 431; break;
      case 3: valor = 797; break;
      case 4: valor = 1163; break;
      case 5: valor = 1528; break;
      case 6: valor = 1893; break;
      case 7: valor = 2258; break;
      case 8: valor = 2624; break;
      case 9: valor = 2989; break;
      case 10: valor = 3354; break;
      default: valor = 3354;
    }
    return valor;
  }
  
  function getCaixas(saldo) {
    var caixas = [];
    for (var i = 0; i < 10; i++) {
      var val;
      if (i === 0) {
        val = faixa(saldo);
      } else {
        var soma = caixas.reduce(function(acc, v) { return acc + v; }, 0);
        val = Math.round(faixa(saldo - soma));
      }
      caixas.push(val);
    }
    return caixas;
  }
  
  function getParcelas(caixas, fator) {
    var parcelas = [];
    for (var i = 0; i < caixas.length; i++) {
      parcelas.push(caixas[i] / Math.pow(fator, desagio(i + 1)));
    }
    return parcelas;
  }
  
  function calcularFGTS(saldo) {
    var formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    if (saldo <= 0) {
      return {
        valor_liberado: formatter.format(0),
        saldo_pedido: formatter.format(0),
        valor_liberado_bmg: formatter.format(0),
        taxa_de_juros: "0"
      };
    }
    var parcelasFixas = 5;
    var taxaDeJuros = taxadejurosmes(parcelasFixas);
    var fator = fatox(taxaDeJuros);
    var caixas = getCaixas(saldo);
    var parcelasArray = getParcelas(caixas, fator);
    var totalCaixa = caixas.slice(0, parcelasFixas).reduce(function(acc, val) { return acc + val; }, 0);
    var totalFluxoLiberado = parcelasArray.slice(0, parcelasFixas).reduce(function(acc, val) { return acc + val; }, 0);
    return {
      valor_liberado: formatter.format(totalCaixa),
      saldo_pedido: formatter.format(saldo),
      valor_liberado_bmg: formatter.format(totalFluxoLiberado),
      taxa_de_juros: taxaDeJuros
    };
  }
  
  function atualizarValoresFGTS(valores) {
    document.getElementById('resultado-fgts').innerHTML = `
      <p class="valor-utilizado" style="margin:8px 0; font-size:16px;">
        Será utilizado apenas <strong>${valores.valor_liberado}</strong> do seu saldo de <strong>${valores.saldo_pedido}</strong> para essa operação.
      </p>
      <p class="valor-liberado" style="margin:8px 0; font-size:16px;">
        Valor liberado: <strong>${valores.valor_liberado_bmg}</strong>
      </p>
      <p class="taxa-de-juros" style="margin:8px 0; font-size:16px;">
        Taxa de juros (ao mês): <strong>${valores.taxa_de_juros}%</strong>
      </p>
      <p class="prazo-pagamento" style="margin:8px 0; font-size:16px;">
        Prazo médio de pagamento: <strong>Antecipação referente ao ano</strong>
      </p>
    `;
  }
  
  global.calcularFGTSHandler = calcularFGTSHandler;
})(window);
