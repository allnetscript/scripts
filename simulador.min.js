(function(global) {
  // Função principal para inicializar o simulador
  function initSimulador(options) {
    var container = document.querySelector(options.container);
    if (!container) return;
    
    // Define a cor base informada pelo cliente (padrão: #012049)
    var cor = options.cor || "#012049";
    // Define a cor para o hover; se não informado, usa a mesma da cor base
    var corHover = options.corHover || cor;
    
    // Carrega o JSON de configuração
    $.getJSON(options.configUrl)
      .done(function(config) {
        // Gera o HTML com os três simuladores
        container.innerHTML = gerarHTML(config, cor, corHover);
        // Atribui os eventos
        aplicarEventos(config);
      })
      .fail(function() {
        container.innerHTML = "<p>Erro ao carregar o simulador. Tente novamente mais tarde.</p>";
      });
  }
  
  // Gera o HTML com os blocos para INSS, FGTS e Servidores Públicos
  function gerarHTML(config, cor, corHover) {
    return `
      <!-- Seletor de produto -->
      <div style="max-width:500px; margin:20px auto; text-align:center;">
        <label for="tipo-credito" style="display:block; margin-bottom:5px; color:#FFF; font-size:1rem;">
          ${config.textos.selecioneProduto}
        </label>
        <select id="tipo-credito" style="width:100%; padding:10px; font-size:1rem; margin-bottom:20px; border:1px solid #ccc; background:#fff; color:${cor};">
          ${config.produtos.map(prod => `<option value="${prod.value}">${prod.text}</option>`).join("")}
        </select>
      </div>
      
      <!-- Simulador INSS -->
      <div id="calculadora-inss" style="display:none; max-width:500px; margin:0 auto; background:#f8f8f8; border:1px solid #ccc; border-radius:10px; padding:30px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h2 style="color:${cor}; font-size:22px; font-family:Arial, sans-serif; margin-bottom:20px;">
          ${config.textos.tituloInss}
        </h2>
        <div class="input-container" style="display:flex; align-items:center; justify-content:center; margin-bottom:20px;">
          <span class="currency-prefix" style="background:${cor}; color:#FFF; height:44px; width:44px; display:flex; align-items:center; justify-content:center; font-size:20px; border-top-left-radius:5px; border-bottom-left-radius:5px;">R$</span>
          <input type="text" id="valor-inss" placeholder="0,00" style="padding:8px 16px; height:44px; font-size:18px; border:1px solid #ccc; border-left:none; width:60%; outline:none;">
          <button id="calcular-inss" style="height:44px; width:50px; background:${cor}; border:none; border-top-right-radius:5px; border-bottom-right-radius:5px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="11" height="18" viewBox="0 0 11 18">
              <g fill="none" stroke="#FFF" stroke-linecap="round" stroke-width="3">
                <path d="M2 2l6 6"></path>
                <path d="M2 16l6-6"></path>
              </g>
            </svg>
          </button>
        </div>
        <div class="result-info" id="resultado-inss" style="background:${cor}; color:#FFF; border-radius:5px; padding:20px; text-align:left; font-family:Arial, sans-serif;">
          <p id="inss-parcelas" style="margin:8px 0; font-size:16px;">${config.textos.parcelas}: <strong>${config.inss.parcelas} ${config.textos.vezes}</strong></p>
          <p id="inss-parcela" style="margin:8px 0; font-size:16px;">${config.textos.parcela}: <strong>R$ 0,00</strong></p>
          <p id="inss-taxa" style="margin:8px 0; font-size:16px;">${config.textos.taxaJuros}: <strong>${config.inss.taxa}%</strong></p>
          <p id="inss-cet" style="margin:8px 0; font-size:16px;">${config.textos.cet}: <strong>${config.inss.cet}%</strong></p>
        </div>
      </div>
      
      <!-- Simulador FGTS -->
      <div id="calculadora-fgts" style="display:none; max-width:500px; margin:20px auto 0; background:#f8f8f8; border:1px solid #ccc; border-radius:10px; padding:30px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h2 style="color:${cor}; font-size:22px; font-family:Arial, sans-serif; margin-bottom:20px;">
          ${config.textos.tituloFgts}
        </h2>
        <div class="input-container" style="display:flex; align-items:center; justify-content:center; margin-bottom:20px;">
          <span class="currency-prefix" style="background:${cor}; color:#FFF; height:44px; width:44px; display:flex; align-items:center; justify-content:center; font-size:20px; border-top-left-radius:5px; border-bottom-left-radius:5px;">R$</span>
          <input type="text" id="fgts-valor" placeholder="0,00" style="padding:8px 16px; height:44px; font-size:18px; border:1px solid #ccc; border-left:none; width:60%; outline:none;">
          <button id="calcular-fgts" style="height:44px; width:50px; background:${cor}; border:none; border-top-right-radius:5px; border-bottom-right-radius:5px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="11" height="18" viewBox="0 0 11 18">
              <g fill="none" stroke="#FFF" stroke-linecap="round" stroke-width="3">
                <path d="M2 2l6 6"></path>
                <path d="M2 16l6-6"></path>
              </g>
            </svg>
          </button>
        </div>
        <div class="result-info" id="resultado-fgts" style="background:${cor}; color:#FFF; border-radius:5px; padding:20px; text-align:left; font-family:Arial, sans-serif;">
          <p class="valor-utilizado" style="margin:8px 0; font-size:16px;">
            ${config.textos.fgtsUtilizado.replace("{valor}", "R$ 0,00").replace("{saldo}", "R$ 0,00")}
          </p>
          <p class="valor-liberado" style="margin:8px 0; font-size:16px;">
            ${config.textos.fgtsLiberado}: <strong>R$ 0,00</strong>
          </p>
          <p class="taxa-de-juros" style="margin:8px 0; font-size:16px;">
            ${config.textos.taxaJuros}: <strong>0%</strong>
          </p>
          <p class="prazo-pagamento" style="margin:8px 0; font-size:16px;">
            ${config.textos.prazoPagamento}
          </p>
        </div>
      </div>
      
      <!-- Simulador Servidores Públicos -->
      <div id="calculadora-servidor" style="display:none; max-width:500px; margin:20px auto 0; background:#f8f8f8; border:1px solid #ccc; border-radius:10px; padding:30px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h2 style="color:${cor}; font-size:22px; font-family:Arial, sans-serif; margin-bottom:20px;">
          ${config.textos.tituloServidor}
        </h2>
        <div class="input-container" style="display:flex; align-items:center; justify-content:center; margin-bottom:20px;">
          <span class="currency-prefix" style="background:${cor}; color:#FFF; height:44px; width:44px; display:flex; align-items:center; justify-content:center; font-size:20px; border-top-left-radius:5px; border-bottom-left-radius:5px;">R$</span>
          <input type="text" id="valor-servidor" placeholder="0,00" style="padding:8px 16px; height:44px; font-size:18px; border:1px solid #ccc; border-left:none; width:60%; outline:none;">
          <button id="calcular-servidor" style="height:44px; width:50px; background:${cor}; border:none; border-top-right-radius:5px; border-bottom-right-radius:5px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="11" height="18" viewBox="0 0 11 18">
              <g fill="none" stroke="#FFF" stroke-linecap="round" stroke-width="3">
                <path d="M2 2l6 6"></path>
                <path d="M2 16l6-6"></path>
              </g>
            </svg>
          </button>
        </div>
        <div class="result-info" id="resultado-servidor" style="background:${cor}; color:#FFF; border-radius:5px; padding:20px; text-align:left; font-family:Arial, sans-serif;">
          <p id="servidor-parcelas" style="margin:8px 0; font-size:16px;">${config.textos.parcelas}: <strong>${config.servidor.parcelas} vezes</strong></p>
          <p id="servidor-parcela" style="margin:8px 0; font-size:16px;">${config.textos.parcela}: <strong>R$ 0,00</strong></p>
          <p id="servidor-taxa" style="margin:8px 0; font-size:16px;">${config.textos.taxaJuros}: <strong>${config.servidor.taxa}%</strong></p>
          <p id="servidor-aviso" style="margin:8px 0; font-size:14px; color:#FFF;"></p>
        </div>
      </div>
      
      <!-- Estilos para hover e estados ativos -->
      <style>
        #tipo-credito:hover,
        button:hover {
          background-color: ${corHover} !important;
          color: #FFF !important;
        }
        @media (hover: none) {
          #tipo-credito:active,
          button:active {
            background-color: ${corHover} !important;
            color: #FFF !important;
          }
        }
        #tipo-credito:focus,
        button:focus {
          outline: none !important;
          box-shadow: none !important;
        }
      </style>
    `;
  }
  
  // Atribui os eventos: alterna o simulador conforme seleção e vincula os cliques
  function aplicarEventos(config) {
    var tipoCredito    = document.getElementById('tipo-credito'),
        calcINSS       = document.getElementById('calculadora-inss'),
        calcFGTS       = document.getElementById('calculadora-fgts'),
        calcServidor   = document.getElementById('calculadora-servidor');
    
    function alternarSimulador() {
      var val = tipoCredito.value;
      calcINSS.style.display = (val === 'inss') ? 'block' : 'none';
      calcFGTS.style.display = (val === 'fgts') ? 'block' : 'none';
      calcServidor.style.display = (val === 'servidor') ? 'block' : 'none';
    }
    tipoCredito.addEventListener('change', alternarSimulador);
    alternarSimulador();
    
    jQuery("#valor-inss, #fgts-valor, #valor-servidor").mask('#.##0,00', { reverse: true });
    
    document.getElementById('calcular-inss').addEventListener('click', function() {
      if (typeof calcularINSS === 'function') {
        calcularINSS();
      }
    });
    document.getElementById('calcular-fgts').addEventListener('click', function() {
      if (typeof calcularFGTSHandler === 'function') {
        calcularFGTSHandler();
      }
    });
    document.getElementById('calcular-servidor').addEventListener('click', function() {
      if (typeof calcularServidor === 'function') {
        calcularServidor();
      }
    });
  }
  
  global.initSimulador = initSimulador;
})(window);
